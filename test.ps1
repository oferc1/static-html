$allApps="welcome,sign-in,personalize-it,pricing-execution,simulation-and-reporting-layer,time-it,machine-learning-platform"
$apps= ($args[0] -eq "all") ? ${allApps}.split(","): $args[0].split(",")
rm -rf package
Foreach ($app in $apps)
{
    if (!$app.Contains("@"))
    {
        $app = $app + "@dev"
    } 
    npm pack $app --registry=http://factory.earnix.local:8081/artifactory/api/npm/npm/
}

Get-ChildItem '.' -Filter *.tgz | Foreach { tar -xvzf $_.fullname }

New-Item -ItemType Directory -Force -Path package/dist/config
$protocol = ($args[1] -eq "localhost") ? "http": "https"
$port = ($protocol -eq "http") ? 8080 : 443
$host_name = $args[1]
$jsonBase = @{}
$backend = @{}
$jsonBase.Add("installation","webserver")
$jsonBase.Add("path","")
$backend.Add("protocol", $protocol)
$backend.Add("host", $host_name)
$backend.Add("serviceKey", $args[2])
$backend.Add("port", $port)
$jsonBase.Add("backend",$backend)
$jsonBase | ConvertTo-Json -Depth 10 | Out-File "package/dist/config/env.json"
New-Item -ItemType Directory -Force -Path package/dist/earnix/web/feature
New-Item -Path package/dist/earnix/web/feature -Name "toggle" -ItemType "file" -Value '[{"id":"PRICING_MODULE","name":"Pricing","description":"Allows to create optimised pricing versions","type":"LICENSE","enabled":true},{"id":"RISK_PREMIUM_MODULE","name":"Risk Premium Estimation","description":"Allows to create risk modeling projects","type":"LICENSE","enabled":true},{"id":"PERSONALIZEIT_MODULE","name":"Personalize-it","description":"Personalize It Module","type":"LICENSE","enabled":false},{"id":"BIG_LUT","name":"Big Lookup Tables","description":"Big lookup tables for postal data, etc.","type":"PROPERTY","enabled":false},{"id":"ASYNCHRONOUS_DELETE","name":"Asynchronous Delete","description":"Fast navigator item deletion with background task","type":"PROPERTY","enabled":true},{"id":"ASYNCHRONOUS_SIMULATION_PROJECT_DELETE","name":"Asynchronous Simulation Delete","description":"Delete stale old simulation projects asynchronously ","type":"PROPERTY","enabled":true},{"id":"DGAM","name":"Distributed GLM/GAM","description":"Calculate GAM/GLM models using distributed framework","type":"PROPERTY","enabled":true},{"id":"DISCRETE_SOLVER","name":"Discrete Solver","description":"Discrete Solver microservice for RFO","type":"PROPERTY","enabled":false},{"id":"GEO_STRUCTURE_VO_FACTORY_PARALLELISM","name":"GeoStructureVO ","description":"Allow or disable parallelism during a creation of a new GeoStructureVO","type":"PROPERTY","enabled":true},{"id":"DATAROBOT","name":"Data Robot enabled","description":"Allow or disable Importing Data Robot models","type":"PROPERTY","enabled":false},{"id":"ALLOW_NATIVE_XGBOOST_MODELS_FALLBACK","name":"Allow Native XGBoost Models Fallback","description":"Allow fallback to Native XGBoost Model Scorer if the objective function is not supported by the JavaScorer","type":"PROPERTY","enabled":false},{"id":"ONLINE_NOMINALS_OFF_HEAP","name":"Off Heap Nominals in Online","description":"Store nominal values off heap on an Online server","type":"PROPERTY","enabled":false},{"id":"OPTIMIZATION_IGNORE_INHERITED_LAMBDAS_ON_CONSTRAINT_MISMATCH","name":"Ignore inherited lambdas on constraint mismatch","description":"In a case of an optimization version created like a template optimization version, ignore lambdas of a derived constrains if they have no match in the template optimization version","type":"PROPERTY","enabled":true},{"id":"FAST_TEST_SNAPSHOT_REMOVABILITY","name":"Fast test of snapshot removability","description":"Fast testing which snapshots can be removed","type":"PROPERTY","enabled":true},{"id":"SIMULATION_LAYER","name":"Simulation layer","description":"Is simulation layer supported","type":"PROPERTY","enabled":false},{"id":"USE_REPORTING_SERVICE","name":"Use reporting service","description":"Calculate reports using Reporting Service","type":"PROPERTY","enabled":false},{"id":"REPORTING_SERVICE_SUB_TOGGLE_OPTIMIZED","name":"Reporting service for optimized versions","description":"Calculate reports for optimized versions using Reporting Service","type":"PROPERTY","enabled":true},{"id":"IMPORT_CONFIGURATION","name":"Import Configuration","description":"Import Analytical Server database configuration","type":"LICENSE","enabled":true},{"id":"EXPORT_CONFIGURATION","name":"Export Configuration","description":"Export Analytical Server database configuration","type":"LICENSE","enabled":true},{"id":"ADVANCED_DATA_MANAGEMENT","name":"Advanced Actions","description":"Data management ETL actions","type":"LICENSE","enabled":true},{"id":"SCRIPT_EDITING","name":"Data Table Script Editing","description":"Data management script editing","type":"LICENSE","enabled":true},{"id":"REGRESSION","name":"Regression","description":"Regression(GLM/GAM) models","type":"LICENSE","enabled":true},{"id":"REG_TREE","name":"Regression Trees","description":"Regression Tree Models","type":"LICENSE","enabled":true},{"id":"MULTI_YEAR_OPTIMIZATION","name":"Multi Year Optimization","description":"Multi-Term Pricing Models","type":"LICENSE","enabled":true},{"id":"AGGREGATIVE_CONSTRAINTS","name":"Aggregative Constraints","description":"Pricing models with aggregative constraints","type":"LICENSE","enabled":true},{"id":"PRICING_EXPOSE","name":"Pricing Exposure","description":"Expose pricing version as a data table","type":"LICENSE","enabled":true},{"id":"SECTORIZED_OPTIMIZATION","name":"Sectorized Optimization","description":"Sectorized Optimization Pricing Model","type":"LICENSE","enabled":true},{"id":"MULTI_VARIATE_OPTIMIZATION","name":"Multi-Variate Optimization","description":"Multi-variate Optimization Pricing Model","type":"LICENSE","enabled":true},{"id":"CONFIGURABLE_PRODUCTS","name":"Configurable Products","description":"Multi-nomial pricing","type":"LICENSE","enabled":true},{"id":"CONTROL_GROUPS","name":"Control Groups","description":"Control groups for monitoring versions","type":"LICENSE","enabled":true},{"id":"ON_LINE_INTEGRATION","name":"On-Line Integration","description":"Pricing execution","type":"LICENSE","enabled":true},{"id":"MULTI_USER","name":"Multi User","description":"Multi users support","type":"LICENSE","enabled":true},{"id":"GEO","name":"Geo Analysis","description":"Geographic data and maps","type":"LICENSE","enabled":true},{"id":"INDIVIDUAL_OPTIMIZATION","name":"Individual Optimization","description":"Individual Optimisation Pricing Model","type":"LICENSE","enabled":true},{"id":"RF_OPTIMIZATION","name":"Rating Factors Optimization","description":"Rating Factor Optimisation Pricing Model","type":"LICENSE","enabled":true},{"id":"PRICING_EXECUTION","name":"Pricing Execution","description":"Management of Online Servers","type":"LICENSE","enabled":true},{"id":"PRICING_TESTING","name":"Pricing Testing","description":"Online testing projects","type":"LICENSE","enabled":true},{"id":"STOCHASTIC","name":"Stochastic","description":"Stochastic optimisation functions","type":"LICENSE","enabled":true},{"id":"PYTHON_AUTOMATION","name":"Automation (Py)","description":"Python Automation Feature","type":"LICENSE","enabled":true},{"id":"DYNAMIC_PRICE_TUNER","name":"Dynamic Price Tuner","description":"Pricing model that responds to changes in demand","type":"LICENSE","enabled":true},{"id":"QUOTE_SAVING","name":"Quotes Saving","description":"Logging of online quotes and import to Data Management","type":"LICENSE","enabled":true},{"id":"DIAMOND_PROJECT_LINKING","name":"Allows project linking \"diamonds\"","description":"Allows to link a project to another project which implies having several linking chain paths between 2 projects (aka Diamond)","type":"PROPERTY","enabled":false},{"id":"CSV_INJECTION_IMPORT_SCANNING","name":"CSV Injection import","description":"Scan CSV files during import","type":"PROPERTY","enabled":false},{"id":"CSV_INJECTION_EXPORT_SCANNING","name":"CSV Injection export","description":"Scan CSV files during export","type":"PROPERTY","enabled":false},{"id":"GBM_MODEL","name":"GBM Model","description":"Gradient Boosting Machine (GBM)","type":"LICENSE","enabled":true},{"id":"H2O_MODEL","name":"Import H2O Model","description":"Import H2O Model","type":"LICENSE","enabled":true},{"id":"AD_LOGIN_EXTERNAL_MANAGED_SSO","name":"Login from Active Directory","description":"Enables SSO login threw Windows Active Directory","type":"PROPERTY","enabled":false},{"id":"SIMULATION_PORTFOLIO_PROJECT","name":"Portfolio Simulation Project","description":"Allow Actions on Portfolio Simulation Project","type":"PROPERTY","enabled":false},{"id":"DASHBOARDS","name":"Dashboards","description":"Is Dashboards tab supported","type":"PROPERTY","enabled":false},{"id":"MULTINOMIAL_REGRESSION","name":"Multinomial Regression","description":"Multinomial Regression","type":"LICENSE","enabled":true},{"id":"ONLINE_ENDPOINTS","name":"Online Endpoints","description":"Enables Online Endpoints","type":"PROPERTY","enabled":false},{"id":"ML_PLATFORM","name":"Machine Learning Platform","description":"Use and manage advanced ML models.","type":"PROPERTY","enabled":false}]'

npx --yes http-server ./package/dist --proxy="http://${host_name}"
